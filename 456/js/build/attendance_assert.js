!function(factory){"function"==typeof define&&define.amd?define(["jquery"],factory):factory("object"==typeof exports?require("jquery"):jQuery)}(function($){var caretTimeoutId,ua=navigator.userAgent,iPhone=/iphone/i.test(ua),chrome=/chrome/i.test(ua),android=/android/i.test(ua);$.mask={definitions:{"N":"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},autoclear:!0,dataName:"rawMaskFn",placeholder:"_"},$.fn.extend({caret:function(begin,end){var range;if(0!==this.length&&!this.is(":hidden"))return "number"==typeof begin?(end="number"==typeof end?end:begin,this.each(function(){this.setSelectionRange?this.setSelectionRange(begin,end):this.createTextRange&&(range=this.createTextRange(),range.collapse(!0),range.moveEnd("character",end),range.moveStart("character",begin),range.select())})):(this[0].setSelectionRange?(begin=this[0].selectionStart,end=this[0].selectionEnd):document.selection&&document.selection.createRange&&(range=document.selection.createRange(),begin=0-range.duplicate().moveStart("character",-1e5),end=begin+range.text.length),{begin:begin,end:end})},unmask:function(){return this.trigger("unmask")},mask:function(mask,settings){var input,defs,tests,partialPosition,firstNonMaskPos,lastRequiredNonMaskPos,len,oldVal;if(!mask&&this.length>0){input=$(this[0]);var fn=input.data($.mask.dataName);return fn?fn():void 0}
return settings=$.extend({autoclear:$.mask.autoclear,placeholder:$.mask.placeholder,completed:null},settings),defs=$.mask.definitions,tests=[],partialPosition=len=mask.length,firstNonMaskPos=null,$.each(mask.split(""),function(i,c){"?"==c?(len--,partialPosition=i):defs[c]?(tests.push(new RegExp(defs[c])),null===firstNonMaskPos&&(firstNonMaskPos=tests.length-1),partialPosition>i&&(lastRequiredNonMaskPos=tests.length-1)):tests.push(null)}),this.trigger("unmask").each(function(){function tryFireCompleted(){if(settings.completed){for(var i=firstNonMaskPos;lastRequiredNonMaskPos>=i;i++)if(tests[i]&&buffer[i]===getPlaceholder(i))return;settings.completed.call(input)}}
function getPlaceholder(i){return settings.placeholder.charAt(i<settings.placeholder.length?i:0)}
function seekNext(pos){for(;++pos<len&&!tests[pos];);return pos}
function seekPrev(pos){for(;--pos>=0&&!tests[pos];);return pos}
function shiftL(begin,end){var i,j;if(!(0>begin)){for(i=begin,j=seekNext(end);len>i;i++)if(tests[i]){if(!(len>j&&tests[i].test(buffer[j])))break;buffer[i]=buffer[j],buffer[j]=getPlaceholder(j),j=seekNext(j)}
writeBuffer(),input.caret(Math.max(firstNonMaskPos,begin))}}
function shiftR(pos){var i,c,j,t;for(i=pos,c=getPlaceholder(pos);len>i;i++)if(tests[i]){if(j=seekNext(i),t=buffer[i],buffer[i]=c,!(len>j&&tests[j].test(t)))break;c=t}}
function androidInputEvent(){var curVal=input.val(),pos=input.caret();if(curVal.length<oldVal.length){for(checkVal(!0);pos.begin>0&&!tests[pos.begin-1];)pos.begin--;if(0===pos.begin)for(;pos.begin<firstNonMaskPos&&!tests[pos.begin];)pos.begin++;input.caret(pos.begin,pos.begin)}else{for(checkVal(!0);pos.begin<len&&!tests[pos.begin];)pos.begin++;input.caret(pos.begin,pos.begin)}
tryFireCompleted()}
function blurEvent(){checkVal(),input.val()!=focusText&&input.change()}
function keydownEvent(e){if(!input.prop("readonly")){var pos,begin,end,k=e.which||e.keyCode;oldVal=input.val(),8===k||46===k||iPhone&&127===k?(pos=input.caret(),begin=pos.begin,end=pos.end,end-begin===0&&(begin=46!==k?seekPrev(begin):end=seekNext(begin-1),end=46===k?seekNext(end):end),clearBuffer(begin,end),shiftL(begin,end-1),e.preventDefault()):13===k?blurEvent.call(this,e):27===k&&(input.val(focusText),input.caret(0,checkVal()),e.preventDefault())}}
function keypressEvent(e){if(!input.prop("readonly")){var p,c,next,k=e.which||e.keyCode,pos=input.caret();if(!(e.ctrlKey||e.altKey||e.metaKey||32>k)&&k&&13!==k){if(pos.end-pos.begin!==0&&(clearBuffer(pos.begin,pos.end),shiftL(pos.begin,pos.end-1)),p=seekNext(pos.begin-1),len>p&&(c=String.fromCharCode(k),tests[p].test(c))){if(shiftR(p),buffer[p]=c,writeBuffer(),next=seekNext(p),android){var proxy=function(){$.proxy($.fn.caret,input,next)()};setTimeout(proxy,0)}else input.caret(next);pos.begin<=lastRequiredNonMaskPos&&tryFireCompleted()}
e.preventDefault()}}}
function clearBuffer(start,end){var i;for(i=start;end>i&&len>i;i++)tests[i]&&(buffer[i]=getPlaceholder(i));}
function writeBuffer(){input.val(buffer.join(""))}
function checkVal(allow){var i,c,pos,test=input.val(),lastMatch=-1;for(i=0,pos=0;len>i;i++)if(tests[i]){for(buffer[i]=getPlaceholder(i);pos++<test.length;)if(c=test.charAt(pos-1),tests[i].test(c)){buffer[i]=c,lastMatch=i;break}
if(pos>test.length){clearBuffer(i+1,len);break}}else buffer[i]===test.charAt(pos)&&pos++,partialPosition>i&&(lastMatch=i);return allow?writeBuffer():partialPosition>lastMatch+1?settings.autoclear||buffer.join("")===defaultBuffer?(input.val()&&input.val(""),clearBuffer(0,len)):writeBuffer():(writeBuffer(),input.val(input.val().substring(0,lastMatch+1))),partialPosition?i:firstNonMaskPos}
var input=$(this),buffer=$.map(mask.split(""),function(c,i){return "?"!=c?defs[c]?getPlaceholder(i):c:void 0}),defaultBuffer=buffer.join(""),focusText=input.val();input.data($.mask.dataName,function(){return $.map(buffer,function(c,i){return tests[i]&&c!=getPlaceholder(i)?c:null}).join("")}),input.one("unmask",function(){input.off(".mask").removeData($.mask.dataName)}).on("focus.mask",function(){if(!input.prop("readonly")){clearTimeout(caretTimeoutId);var pos;focusText=input.val(),pos=checkVal(),caretTimeoutId=setTimeout(function(){writeBuffer(),pos==mask.replace("?","").length?input.caret(0,pos):input.caret(pos)},10)}}).on("blur.mask",blurEvent).on("keydown.mask",keydownEvent).on("keypress.mask",keypressEvent).on("input.mask paste.mask",function(){input.prop("readonly")||setTimeout(function(){var pos=checkVal(!0);input.caret(pos),tryFireCompleted()},0)}),chrome&&android&&input.off("input.mask").on("input.mask",androidInputEvent),checkVal()})}})});$(document).ready(function(){$(document).on("keyup",'input.sp-ip-phone',function(){this.value=this.value.replace(/[^0-9\.]/g,'')});$(document).on("click",".phone-inputer,.fp-ip-phone,.sp-ip-phone",function(e){$(".errors-cnt-simple").html("").hide()})
$(document).on("click","#add-ip-phone",function(e){var ipPhoneFp=$("#ip-phones-container").find("select.fp-ip-phone").val();var ipPhoneSp=$("#ip-phones-container").find("input.sp-ip-phone").val();if(ipPhoneFp.length==0||ipPhoneSp.length==0){$(".errors-cnt-simple").html("<p class='alert alert-warning'>Нужно заполнить оба поля</p>").show();disappear(".errors-cnt-simple",1000);return}else{if((ipPhoneFp+ipPhoneSp).length!=5){$(".errors-cnt-simple").html("<p class='alert alert-warning'>Длина телефона должна быть 5 символов</p> ").show()
disappear(".errors-cnt-simple",1000);return}
var obj={'id':"ip_phone_"+ipPhoneFp+ipPhoneSp,'pathString':"ip_phone_"+ipPhoneFp+ipPhoneSp};var t=stack.putVirtual(obj);if(t){stackViewer.viewFromVirtual("#stack-content",t)}
$("#ip-phones-container").find("input.sp-ip-phone").val("")}})
$(document).on("click","#add-phone",function(e){$(".errors-cnt-simple").html("").hide();if($(".phone-inputer").attr("disabled")=="disabled")
return;var value1=$(".phone-inputer").val();if(value1.length!=0){var obj={'id':"phone_"+value1,'pathString':"phone_"+value1};var t=stack.putVirtual(obj);if(t){stackViewer.viewFromVirtual("#stack-content",t)}
$(".phone-inputer").val('');addPointNotificator("#points-notificator","Добавлено")}else{$(".errors-cnt-simple").html("<div class='alert alert-danger'>Номер должен точно соответсвовать шаблону</div> ").show();disappear(".errors-cnt-simple",1000)}});$(document).on("click",".phone-tmpl-select-me",function(e){$(".errors-cnt-simple").html("").hide();$(".phone-field-hidden").removeClass("hidden");addActive($(this));var myTpl=$(this).find('span').data('phone_tpl');$(".phone-inputer").mask(myTpl);$(".phone-inputer").attr("disabled",!1);$(".phone-inputer").focus()})})
function flushcontainer(container){$(container).find(".point").remove()}
function addActive($this){$($this).parent().find(".active").removeClass('active').removeClass('btn-info');$($this).addClass('active btn-info')};(function(factory){if(typeof define==='function'&&define.amd){define(['jquery'],factory)}else if(typeof exports==='object'){factory(require('jquery'))}else{factory(jQuery)}}(function($){var pluses=/\+/g;function encode(s){return config.raw?s:encodeURIComponent(s)}
function decode(s){return config.raw?s:decodeURIComponent(s)}
function stringifyCookieValue(value){return encode(config.json?JSON.stringify(value):String(value))}
function parseCookieValue(s){if(s.indexOf('"')===0){s=s.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,'\\')}
try{s=decodeURIComponent(s.replace(pluses,' '));return config.json?JSON.parse(s):s}catch(e){}}
function read(s,converter){var value=config.raw?s:parseCookieValue(s);return $.isFunction(converter)?converter(value):value}
var config=$.cookie=function(key,value,options){if(arguments.length>1&&!$.isFunction(value)){options=$.extend({},config.defaults,options);if(typeof options.expires==='number'){var days=options.expires,t=options.expires=new Date();t.setTime(+t+days*864e+5)}
return(document.cookie=[encode(key),'=',stringifyCookieValue(value),options.expires?'; expires='+options.expires.toUTCString():'',options.path?'; path='+options.path:'',options.domain?'; domain='+options.domain:'',options.secure?'; secure':''].join(''))}
var result=key?undefined:{};var cookies=document.cookie?document.cookie.split('; '):[];for(var i=0,l=cookies.length;i<l;i++){var parts=cookies[i].split('=');var name=decode(parts.shift());var cookie=parts.join('=');if(key&&key===name){result=read(cookie,value);break}
if(!key&&(cookie=read(cookie))!==undefined){result[name]=cookie}}
return result};config.defaults={};$.removeCookie=function(key,options){if($.cookie(key)===undefined){return !1}
$.cookie(key,'',$.extend({},options,{expires:-1}));return !$.cookie(key)}}));function Render(stack,blockageStack){this.stack=stack;blockageStack=typeof blockageStack!=='undefined'?blockageStack:new BlockageStack('blockage','1');this.blockageStack=blockageStack}
Render.prototype.renderPage=function(id,cOrder,pOrder,pathHead){cOrder=typeof cOrder!=='undefined'?cOrder:'name_to_asc';pOrder=typeof pOrder!=='undefined'?pOrder:'name_to_asc';$("#containers-container, #points-container").html("");var $this=this;$.ajax({beforeSend:function(){},type:'POST',cache:!1,url:"?route=AttendanceNew/apiGetTree/"+id+"/"+cOrder+"/"+pOrder,success:function(data){data=$.parseJSON(data);$this.renderPath(data,pathHead);$this.renderOrdersSimple(data);if(!data.containers.length)$("#containers-container").append("<div class='text-center'> <h5 class='text-muted'><i>Список пуст</i></h5></div>");if($("#path").children().length>1){$("#cOrder").append("<span class='pull-left btn-link pull_me_up pointer text-primary'><span class='glyphicon glyphicon glyphicon-arrow-left'></span> Назад</span>")}else{$("#cOrder").append("<span class='pull-left text-muted'><span class='glyphicon glyphicon glyphicon-arrow-left'></span> Назад</span>")}
$.each(data.containers,function(e,element){$("#containers-container").append($this.renderPlank(element))});if(!data.points.length){$("#points-container").append("<div class='text-center'><h5 class='text-muted'><i>Список пуст</i></h5></div>");$("#pOrder").append("<span class='pull-left  text-muted'>Добавить все <span class='glyphicon glyphicon-indent-left'></span></span>")}else{$("#pOrder").append("<span class='pull-left btn-link select_all_points pointer text-primary'>Добавить все <span class='glyphicon glyphicon-indent-left'></span></span>")}
$.each(data.points,function(e,element){$("#points-container").append($this.renderPlank(element))});$('[data-toggle="tooltip"]').tooltip()},complete:function(){$(".loader, .roller").remove()}})}
Render.prototype.renderPlank=function(element){var result='<div';if(this.isContainer(element)){result+=" class='browse plank plank-container'"}else{if(this.stack.exist(element.id)||this.blockageStack.exist(element.id))
result+=" class='points plank plank-point-deactivated' data-toggle='tooltip' data-placement='left' title='Точка уже выбрана'";else result+=" class='points plank plank-point' "}
result+=" data-id='"+element.id+"'";result+=" data-path_string='"+element.pathString+"'>";if(this.isContainer(element)){result+="<div class='col-sm-2 text-right '><span title='Выбрать все точки в этом контейнере' data-toggle='tooltip' data-placement='top' class='plank-select-all btn-link badge' data-id='"+element.id+"'>"+element.childs.length+"</span></div>"}else{}
result+="<div class='col-sm-10'><span class='container-name'>"+element.name+"</span></div> ";result+="</div>";return result}
Render.prototype.renderOrders=function(data){var pointsOE=$("#pOrder");var containersOE=$("#cOrder");pointsOE.html('');containersOE.html('');var elementPOE=this.generateOrderElement('POE',data.pOrder);var elementCOE=this.generateOrderElement('COE',data.cOrder);pointsOE.append(elementPOE);containersOE.append(elementCOE)}
Render.prototype.renderOrdersSimple=function(data){var pointsOE=$("#pOrder");var containersOE=$("#cOrder");pointsOE.html('');containersOE.html('');var elementPOE=this.generateOrderElementSimple(data.pOrder);var elementCOE=this.generateOrderElementSimple(data.cOrder);pointsOE.append(elementPOE).show();containersOE.append(elementCOE).show()}
Render.prototype.generateOrderElement=function(mark,startPack){var result='';var optionsFields=[];var optionsDirs=[];startPack=startPack.split("_to_");optionsFields.push(startPack[0]);optionsDirs.push(startPack[1]);var orderFieldsSet=['id','name','created_at'];var orderDirsSet=['asc','desc'];for(var i=0;i<orderFieldsSet.length;i++){if($.inArray(orderFieldsSet[i],optionsFields)=="-1")
optionsFields.push(orderFieldsSet[i])}
for(var i=0;i<orderDirsSet.length;i++){if($.inArray(orderDirsSet[i],optionsDirs)=="-1")
optionsDirs.push(orderDirsSet[i])}
result+="<div class='col-lg-2 nopadding'><select id='field' class='order form-control'>";for(var i=0;i<optionsFields.length;i++){result+="<option value='"+optionsFields[i]+"'>"+this.humanizeField(optionsFields[i])+"</option>"}
result+="</select></div>";result+="<div class='col-lg-2 nopadding'><select id='dir' class='order form-control'>";for(var i=0;i<orderDirsSet.length;i++){result+="<option value='"+optionsDirs[i]+"'>"+this.humanizeDirection(optionsDirs[i])+"</option>"}
result+="</select></div>";return result}
Render.prototype.generateOrderElementSimple=function(startPack){var result='';var currentdirection;currentdirection=startPack.split("_to_")[1];result+="<span class='h6'><span class='oDirect btn-link pointer' data-direct='"+currentdirection+"'>"+this.humanizeDirection(currentdirection)+"</span></span>";return result}
Render.prototype.renderPath=function(data,head){head=typeof head!=='undefined'?head:'1';var result='';var pathElements=[];var head={'dataId':head,'name':''};pathElements.push(head);if(data.path)
for(var i=0;i<data.path.length;i++){point={'dataId':data.path[i].id,'name':data.path[i].name,'parent_id':data.path[i].parent_id};if(head.dataId!=point.dataId)
pathElements.push(point)}
for(var i=0;i<pathElements.length;i++){if(pathElements[i].dataId==head.dataId)
result+="<li><a class='browse' data-id='"+pathElements[i].dataId+"'><span class='glyphicon glyphicon-home text-success pointer'></span></a></li>";else result+="<li><a  class='browse pointer' data-id='"+pathElements[i].dataId+"' data-parent_id='"+pathElements[i].parent_id+"'>"+pathElements[i].name+"</a></li>"}
$("#path").html(result)}
Render.prototype.isContainer=function(element){return Number(element.container)?!0:!1}
Render.prototype.humanizeField=function(field){var result='';switch(field){case("id"):result='Сист. номер';break;case("name"):result='Имя';break;case("created_at"):result='Дата создания';break;default:result='поле не определено';break}
return result}
Render.prototype.humanizeDirection=function(dir){var result='';switch(dir){case("asc"):result="по-возрастанию <span class='glyphicon glyphicon-sort-by-alphabet'></span>";break;case("desc"):result="по-убыванию <span class='glyphicon glyphicon-sort-by-alphabet-alt'></span>";break;default:result='порядок не определен';break}
return result}
Render.prototype.getCurrentElement=function(){return $('#path').find('.browse').last().data('id')}
Render.prototype.renderSearchedElements=function(data){data=$.parseJSON(data);$("#containers-container, #points-container").html("<br>");var $this=this;if(!data.containers.length)$("#containers-container").append("<h5>Ничего не найдено</h5>");$.each(data.containers,function(e,element){$("#containers-container").append($this.renderPlank(element))});if(!data.points.length)$("#points-container").append("<h5>Ничего не найдено</h5>");$.each(data.points,function(e,element){$("#points-container").append($this.renderPlank(element))})};function Stack(name,capacity,outputElement,parsedElement){this.name=name;this.capacity=typeof capacity!=='undefined'?capacity:1;this.outputElement=outputElement;this.virtualStack=[]}
Stack.prototype.clear=function(){$.cookie(this.name,'');return !0};Stack.prototype.read=function(){return this.getVirtual()};Stack.prototype.putVirtual=function(value){if(this.virtualStack.length==this.capacity){if(!$("#error_msg").length){$(".fancybox-skin").prepend("<div class='alert alert-danger' id='error_msg'>Ошибка: Больше значений добавить нельзя, максимум: "+this.capacity+"</div>");disappear("#error_msg",2000)}
return !1}
if(!this.existVirtual(value)){this.virtualStack.push(value)}
return this.virtualStack};Stack.prototype.getVirtual=function(){return this.virtualStack};Stack.prototype.clearVirtual=function(){this.virtualStack=[];return this.virtualStack};Stack.prototype.removeFromVirtual=function(value){var newStack=[];for(var i=0;i<this.virtualStack.length;i++){if(this.virtualStack[i].id!=value){newStack.push(this.virtualStack[i])}}
this.virtualStack=newStack;return this.virtualStack};Stack.prototype.sendToRemoteStorage=function(vstack){var stackData=[];if(vstack.length)
$.each(vstack,function(i,val){stackData.push(val.id)});var data={key:this.name,value:JSON.stringify(stackData)};$.ajax({beforeSend:function(){var opts={lines:17,length:26,width:12,radius:42,scale:0.2,corners:1,color:'#000',opacity:0.25,rotate:11,direction:1,speed:3.2,trail:23,fps:20,zIndex:2e9,className:'spinner',top:'50%',left:'50%',shadow:!1,hwaccel:!1,position:'absolute'}
var spinner=new Spinner(opts).spin();$('#center').append(spinner.el)},type:'post',cache:!1,data:data,async:!1,url:"index.php?route=LocalStorage/set/",success:function(data){},complete:function(){$('.spinner').remove()}})};Stack.prototype.populateFromRemoveServer=function(){var stack=this;$.ajax({beforeSend:function(){var opts={lines:17,length:26,width:12,radius:42,scale:0.2,corners:1,color:'#000',opacity:0.25,rotate:11,direction:1,speed:3.2,trail:23,fps:20,zIndex:2e9,className:'spinner',top:'50%',left:'50%',shadow:!1,hwaccel:!1,position:'absolute'}
var spinner=new Spinner(opts).spin();$('#center').append(spinner.el)},type:'GET',cache:!1,async:!1,url:"index.php?route=AttendanceNew/getStackData/"+this.name,dataType:"json",success:function(data){stack.virtualStack=data},complete:function(){$('.spinner').remove()}})};Stack.prototype.put=function(value){value=String(value);var result=!1;var stack=this.read();if(stack.length==this.capacity){if(!$("#error_msg").length){$(".fancybox-skin").prepend("<div class='alert alert-danger' id='error_msg'>Ошибка: Больше значений добавить нельзя, максимум: "+this.capacity+"</div>");disappear("#error_msg",2000)}
return !1}
if(this.capacity==1){this.clear();stack=this.read();$(".plank-point-deactivated").removeClass("plank-point-deactivated").addClass('plank-point');stack.push(value);result=!0}else{if($.inArray(value,stack)=="-1"){stack.push(value);result=!0}
if(stack.length>this.capacity){stack=stack.slice(stack.length-this.capacity)}}
stack=stack.join(this.delim);$.cookie(this.name,stack);return result};Stack.prototype.remove=function(value){var result=!1;value=String(value);var stack=this.read();var index=$.inArray(value,stack);if(index>-1){stack.splice(index,1);$(".plank-point-deactivated[data-id='"+value+"']").removeClass("plank-point-deactivated").addClass('plank-point');result=!0}
stack=stack.join(this.delim);$.cookie(this.name,stack);return result};Stack.prototype.exist=function(value){var stack=this.getVirtual();for(var i=0;i<stack.length;i++){if(stack[i].id==value){return !0}}
return !1}
Stack.prototype.existVirtual=function(value){var stack=this.getVirtual();for(var i=0;i<stack.length;i++){if(stack[i].id==value.id){return !0}}
return !1};function BlockageStack(name,capacity){this.name=name;this.delim='@@DELIM@@';this.capacity=typeof capacity!=='undefined'?capacity:1}
BlockageStack.prototype.read=function(){var stack=typeof $.cookie(this.name)!=='undefined'?$.cookie(this.name):[];if(stack.length>0){stack=stack.split(this.delim)}else{stack=Array()}
return stack};BlockageStack.prototype.put=function(value){value=String(value);var result=!1;var stack=this.read();if(this.capacity==1){this.clear();stack=this.read();$(".plank-point-deactivated").removeClass("plank-point-deactivated").addClass('plank-point');stack.push(value);result=!0}else{if($.inArray(value,stack)=="-1"){stack.push(value);result=!0}
if(stack.length>this.capacity){stack=stack.slice(stack.length-this.capacity)}}
stack=stack.join(this.delim);$.cookie(this.name,stack);return result};BlockageStack.prototype.exist=function(value){value=String(value);var stack=this.read();var index=$.inArray(value,stack);if(index>-1)
return !0;else return !1};function StackViewer(stack){this.stack=stack}
StackViewer.prototype.view=function(toDiv){$.ajax({beforeSend:function(){},type:'POST',cache:!1,url:"?route=AttendanceNew/getStackData/"+this.stack.name,success:function(data){data=$.parseJSON(data);$(".empty-plank").remove();if(data.length==0){$(toDiv).html("<i class='empty-plank'>Ничего не выбрано</i>");return}
data.reverse();$(toDiv).find(".plank-holder").each(function(){var flag=!1;for(var i=0;i!=data.length;i++){if($(toDiv).find("div[data-id='"+data[i].id+"']").length){flag=!0;break}}
if(!flag)
$(this).remove()});for(var i=0;i!=data.length;i++){if(!$(toDiv).find("div[data-id='"+data[i].id+"']").length){$(toDiv).append("<div class='plank-holder' title='"+data[i].pathString+"' ><span class='glyphicon glyphicon-remove-sign plank-remove text-danger pointer' data-id='"+data[i].id+"'></span> "+data[i].pathString+"</li>")}}},complete:function(){}})};StackViewer.prototype.viewFromVirtual=function(toDiv,stackData){var data=stackData;$(".empty-plank").remove();if(data.length==0){$(toDiv).html("<i class='empty-plank'>Ничего не выбрано</i>");return}
data.reverse();$(toDiv).find(".plank-holder").each(function(){var flag=!1;for(var i=0;i!=data.length;i++){if($(toDiv).find("div[data-id='"+data[i].id+"']").length){flag=!0;break}}
if(!flag)
$(this).remove()});for(var i=0;i!=data.length;i++){if(!$(toDiv).find("div[data-id='"+data[i].id+"']").length){$(toDiv).append("<div class='plank-holder' title='"+data[i].pathString+"' ><span class='glyphicon glyphicon-remove-sign plank-remove-virtual text-danger pointer' data-id='"+data[i].id+"'></span> "+data[i].pathString+"</li>")}}};StackViewer.prototype.display=function(toDiv){$(toDiv).html('');$.post("?route=AttendanceNew/getStackData/"+this.stack.name,function(data){data=$.parseJSON(data);if(data.length==0){$(toDiv).html("<i class='empty-plank'>Ничего не выбрано</i>")}
var list=stack.capacity!=1?"<ol>":"<ul>";for(var i=0;i<data.length;i++){list+="<li title='"+data[i].pathString+"' >"+data[i].pathString+"</li>"}
list+=stack.capacity!=1?"</ol>":"</ul>";$(toDiv).append(list)})}
StackViewer.prototype.displayCounter=function(toDiv,stack){if(stack.length==0){$(toDiv).html(0)}else{$(toDiv).html(stack.length)}};$(document).ready(function(){$(document).on("click",".browse",function(){var $this=$(this);render.renderPage($this.data("id"))})
$(document).on("click",".plank-point",function(){var $this=$(this);var obj={'id':$this.data('id'),'pathString':$this.data('path_string')};var t=stack.putVirtual(obj);if(t){stackViewer.viewFromVirtual("#stack-content",t);$this.removeClass("plank-point").addClass('plank-point-deactivated')}})
$(document).on("click",".plank-remove",function(){$(this).parent().css("background-color","red");var $this=$(this);stack.remove($this.data('id'));$(".plank-point-deactivated[data-id='"+$this.data('id')+"']").removeClass("plank-point-deactivated").addClass('plank-point');$this.removeClass("plank-point").addClass('plank-point-deactivated');stackViewer.view("#stack-content");stackViewer.displayCounter("#stack-counter")});$(document).on("click",".plank-remove-virtual",function(){$(this).parent().css("background-color","red");var $this=$(this);var t=stack.removeFromVirtual($this.data('id'));$(".plank-point-deactivated[data-id='"+$this.data('id')+"']").removeClass("plank-point-deactivated").addClass('plank-point');stackViewer.viewFromVirtual("#stack-content",t);$this.removeClass("plank-point").addClass('plank-point-deactivated')});$(document).on("click","#clear_stack",function(){if(stack.getVirtual().length){if(confirm("Уверены?")){stack.clearVirtual();stackViewer.viewFromVirtual("#stack-content",stack.getVirtual());stackViewer.displayCounter("#stack-counter",stack.getVirtual())}}});$(document).on("change",".order",function(){var cOrder=$("#cOrder").find("#field").val()+"_to_"+$("#cOrder").find("#dir").val();var pOrder=$("#pOrder").find("#field").val()+"_to_"+$("#pOrder").find("#dir").val();render.renderPage(render.getCurrentElement(),cOrder,pOrder)});$(document).on("click",".oDirect",function(){var currentOrder=$(this).data('direct');var newOrder=(currentOrder=='asc')?'desc':'asc';$(this).data('direct',newOrder);var cOrder="name_to_"+$("#cOrder").find(".oDirect").data('direct');var pOrder="name_to_"+$("#pOrder").find(".oDirect").data('direct');render.renderPage(render.getCurrentElement(),cOrder,pOrder)});$(document).on("click",".plank-select-all",function(e){e.stopPropagation();if(stack.capacity==1){alert('В данном случае выбрать сразу несколько участников нельзя')}else{var $this=$(this);if($this.text()!=0){if(confirm("Выбрать все точки в этом контейнере?")){$.post("?route=AttendanceNew/apiGetTree/"+$this.data("id"),function(data){data=$.parseJSON(data);var added=0;$.each(data.points,function(e,element){var obj={'id':element.id,'pathString':element.pathString};if(stack.putVirtual(obj))added++});if(stack.capacity==1){added=1}
stackViewer.viewFromVirtual("#stack-content",stack.getVirtual());stackViewer.displayCounter("#stack-counter",stack.getVirtual())})}}}});$(document).on("click","#close-attendance-form",function(e){$.when(stack.sendToRemoteStorage(stack.getVirtual())).then(stackViewer.display(stack.outputElement));$(".fancybox-close").click();if(isLocationStack(stack)){var stackData=stack.read();if(stackData.length){var techMail=askTechSupport(stackData[0].id);if(techMail){allowTechSupport($("#needTPSupport"))}else{blockTechSupport($("#needTPSupport"))}}else{blockTechSupport($("#needTPSupport"))}}});$(document).on("click",".select_all_points",function(e){if(stack.capacity==1){alert('В данном случае выбрать сразу несколько участников нельзя')
return}
var added=0;var points=$("#points-container").find(".plank-point");$.each(points,function(e,element){var obj={'id':$(element).data('id'),'pathString':$(element).data('path_string')};if(stack.putVirtual(obj))added++;$(element).removeClass("plank-point").addClass("plank-point-deactivated")});if(stack.capacity==1){added=1}
stackViewer.viewFromVirtual("#stack-content",stack.getVirtual());stackViewer.displayCounter("#stack-counter",stack.getVirtual())});$(document).on("click",".pull_me_up",function(e){var last=$("#path").children().last();render.renderPage($(last).find(".pointer").data("parent_id"))})});function addPointNotificator(element,message,type){};$(document).ready(function(){$(document).on("click","#nav-points",function(e){addActive($(this));$("#main-container").show()});$(document).on("click","#nav-phone-nums",function(e){addActive($(this));$("#phone-nums-container").show()});$(document).on("click","#nav-ip-phones",function(e){addActive($(this));$("#ip-phones-container").show()})
function addActive($this){$($this).parent().find(".active").removeClass('active').removeClass('btn-success');$($this).addClass('active btn-success');$(".nav-container").each(function(){$(this).hide()})}});$(document).ready(function(){$(document).on("click","#search-button",function(){$("#cOrder,#pOrder").hide();var $thisButton=$(this);var phrase=$("#search-input").val();if(phrase.length>0){$.ajax({beforeSend:function(){$thisButton.text("идет поиск...").attr("id","wait")},type:'POST',cache:!1,url:"?route=AttendanceNew/apiSearchTree/"+encodeURIComponent(phrase),success:function(data){render.renderSearchedElements(data)},complete:function(){$thisButton.text("найти").attr("id","search-button");if($(".dropme").length==0)
$(".breadcrumb").html("<li class='browse btn btn-warning dropme pointer' data-id='1'>Очистить результаты поиска</li>")}})}});$(document).on("click",".dropme",function(){$(this).remove();$("#cOrder,#pOrder").show();$("#search-input").val("")})
$("#search-input").keypress(function(e){e.stopPropagation();var key=e.which;if(key==13){$("#search-button").click()}})})